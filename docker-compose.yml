version: '2'

services:

  postgres:
    image: postgres:9.4
    volumes:
      - postgresql_data:/var/lib/postgresql/data

  elasticsearch:
    image: elasticsearch:5.2
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data

  rabbitmq:
    image: rabbitmq:3.6
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  django:
    image: camptocamp/geonode_django
    links:
      - postgres
      - elasticsearch
      - rabbitmq
    command: django-admin.py runserver 0.0.0.0:8000 --settings=geonode.settings
    environment:
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/postgres
      - BROKER_URL=amqp://guest:guest@rabbitmq:5672/
      - DJANGO_SETTINGS_MODULE=geonode.settings
      - GEOSERVER_BASE_URL=http://geoserver:8080/geoserver/
      - ALLOWED_HOSTS=['django',]

  celery:
    image: camptocamp/geonode_django
    links:
      - rabbitmq
      - postgres
      - elasticsearch
    command: celery worker --app=geonode.celery_app:app -B -l INFO
    environment:
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/postgres
      - BROKER_URL=amqp://guest:guest@rabbitmq:5672/
      - GEOSERVER_BASE_URL=http://geoserver:8080/geoserver/
      - DJANGO_SETTINGS_MODULE=geonode.settings
      - ALLOWED_HOSTS=['django',]
      - C_FORCE_ROOT=1

  geoserver:
    image: camptocamp/geonode_geoserver
    links:
      - postgres
      - django
    ports:
      - "8080:8080"
    volumes:
      - geoserver_datadir:/usr/local/tomcat/webapps/geoserver/data


  nginx:
    image: camptocamp/geonode_nginx
    links:
      - django
    ports:
      - "80:80"


volumes:
  rabbitmq_data:
  elasticsearch_data:
  geoserver_datadir:
  geoserver_data:
  postgresql_data:
